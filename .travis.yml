---
sudo: true
language: java
jdk: oraclejdk8

script:
  - date
  - cat /etc/*-release
  - hostname
  - hostname -d
  - java -version
  - which java
  
  # Install ruby
  - sudo apt-get install ruby-full
  - sudo gem install puppetlabs_spec_helper
  - sudo gem install facter
  - sudo gem install puppet
  
  # Set hostname
  - sudo cp hosts /etc/hosts
  - sudo cp head /etc/resolvconf/resolv.conf.d/head
  - sudo hostname puppetmaster.localdomain
  - sudo hostname puppet.localdomain
  
  # Install puppet server
  - sudo apt-get update
  - bundle exec rake spec
  - sudo mkdir -p /home/travis/.puppet/manifests/
  - wget https://apt.puppetlabs.com/puppetlabs-release-trusty.deb
  - sudo dpkg --force-all -i puppetlabs-release-trusty.deb
  - sudo apt-get update
  - sudo apt-get install puppetserver
  - sudo apt-get update
  
  # Install puppet agent
  - sudo apt-get install puppet
  - sudo sed -i 's/START=no/START=yes/g' /etc/default/puppet
  - sudo apt-get update
  - sudo puppet resource package puppetmaster ensure=latest
  - puppet -V
  - sudo find / -name puppet 2>/dev/null
  
  
  # Deploy files
  - sudo cp site.pp /home/travis/.puppet/manifests/site.pp
  - sudo cp -f puppet.conf /etc/puppet/puppet.conf
  
  # Sign certs
  - sudo puppet cert generate puppetmaster.localdomain
  - sudo puppet resource package puppet ensure=latest
  - sudo puppet resource service puppet ensure=running enable=true
  - sudo puppet apply --parser=future $(puppet apply --configprint manifest)
  - sudo puppet cert list --all
  #- sudo puppet cert sign --all
  - sudo puppet config set server puppet.localdomain --section agent
  
  # Start pupper server
  #- sudo service puppetmaster start
  - sudo ps -ef | egrep puppet
  
  # Start pupper agent
  #- sudo service puppet start
  
  # Install puppet modules
  - sudo puppet module install rtyler/jenkins
  
  # Run modules
  - sudo cp jenkins.list /etc/apt/sources.list.d/jenkins.list
  - sudo puppet agent -t
  #- sudo puppet apply site.pp
  - sudo puppet apply --parser=future jenkins_init.pp
  - sudo puppet apply --parser=future -e "include jenkins"
  
  # Test agent
  - sudo rm -rf /usr/lib/jvm/java-7-openjdk-amd64
  - cd /tmp && wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war
  - sudo /bin/su - jenkins -c "$JAVA_HOME/bin/java -jar /tmp/jenkins.war --httpPort=8080" &
  - sleep 5
  - sudo ps -ef | egrep jenkins
  - sudo ps -ef | egrep docker
  - alias
  - ls -l $JAVA_HOME/bin
  - cat /etc/passwd
  - sudo netstat -tunpl
  - env | sort
  - sudo ls -l /usr/lib/jvm/
  - echo Done
  
branches:
  only:
  - master
