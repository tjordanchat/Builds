---
sudo: true
language: ruby

addons:
  apt:
    packages:
      - xvfb
      - figlet
      - toilet

install:
  - export DISPLAY=':99'
  - export TZ='America/New_York'
  - sudo apt-get install openjdk-7-jre-headless
  - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
  - sudo apt-get update
  - wget https://apt.puppetlabs.com/puppetlabs-release-trusty.deb
  - sudo dpkg --force-all -i puppetlabs-release-trusty.deb
  - sudo apt-get -y install ntp
  - sudo apt-get update
  - sudo apt-get install puppetmaster
  - sudo apt-get update
  - sudo apt-get install puppet
  - sudo puppet resource package puppetmaster ensure=latest
  - sudo puppet resource service puppetmaster ensure=running enable=true
  - sudo puppet agent
  
script:
  - toilet -f mono12 `date '+%y-%m-%d%n%H.%M'`
  #- cat /etc/*-release 
  #- ps -ef | egrep puppet
  #- ps -ef | egrep docker
  #- sudo netstat -tunpl
  #- hostname
  #- env | sort
  
  - sudo sh -c bin/deploy_puppet
  #- sudo sh -c bin/deploy_root
  
  - export CDIR="$(sudo puppet config print confdir)"
  - sudo puppet apply $CDIR/manifests/site.pp
  
  - sleep 5
  
  - export CLI="$( sudo find / -name jenkins-cli.jar -print 2>/dev/null | sed -n 1p )"
  - export PASS="$( sudo cat /var/lib/jenkins/secrets/initialAdminPassword )"
  - xargs sudo java -jar $CLI -auth admin:$PASS -s http://127.0.0.1:8080/ install-plugin < jenkins_dir/plugins.list
  #- cat /etc/passwd | sort
  #- ps -ef | egrep jenkins
  #- sudo netstat -tunpl
  #- sudo find / -name hiera.yaml 2>/dev/null
  #- sudo hiera --help
  #- sudo facter --help
  #- sudo facter -y
  - sudo git clone https://github.com/cfpb/jenkins-as-code-starter-project.git
  - cd ./jenkins-as-code-starter-project; sudo gradlew rest -Dusername=admin -Dpassword=$PASS -DbaseUrl=http://localhost:8080 -Dpattern=../jenkins_dir/dsl/pipeline.groovy; cd -
  - echo Done
