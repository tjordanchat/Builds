---
sudo: true
language: ruby

addons:
  apt:
    packages:
      - xvfb
      - figlet
      - toilet

install:
  - export DISPLAY=':99'
  - export TZ='America/New_York'
  - sudo apt-get install openjdk-7-jre-headless
  - Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
  - sudo apt-get update
  - wget https://apt.puppetlabs.com/puppetlabs-release-trusty.deb
  - sudo dpkg --force-all -i puppetlabs-release-trusty.deb
  - sudo apt-get -y install ntp
  - sudo apt-get update
  - sudo apt-get install puppetmaster
  - sudo apt-get update
  - sudo apt-get install puppet
  - sudo puppet resource package puppetmaster ensure=latest
  - sudo puppet resource service puppetmaster ensure=running enable=true
  - sudo puppet agent
  
script:
  - toilet -f mono12 `date '+%y-%m-%d%n%H.%M'`
  
  - sudo sh -c bin/deploy_puppet
  
  - export CDIR="$(sudo puppet config print confdir)"
  - sudo puppet apply $CDIR/manifests/site.pp
  
  - sleep 10
  
  - sudo cp /var/cache/jenkins/war/WEB-INF/jenkins-cli.jar bin
  - export CLI=`pwd`/bin/jenkins-cli.jar
  - export PASS="$( sudo cat /var/lib/jenkins/secrets/initialAdminPassword )"
  - xargs sudo java -jar $CLI -auth admin:$PASS -s http://127.0.0.1:8080 install-plugin < jenkins_dir/plugins.list
  #- sudo git clone https://github.com/cfpb/jenkins-as-code-starter-project.git 
  #- cd ./jenkins-as-code-starter-project; ./gradlew rest -Dusername=admin -Dpassword=$PASS -DbaseUrl=http://localhost:8080 -Dpattern=../jenkins_dir/dsl/pipeline.groovy; cd -
  - bin/create_job $PASS $CLI
  - sudo java -jar $CLI -auth admin:$PASS  -s http://127.0.0.1:8080 build 'Pipeline' 
  - sudo java -jar $CLI -auth admin:$PASS  -s http://127.0.0.1:8080 list-jobs 
  - echo Done
